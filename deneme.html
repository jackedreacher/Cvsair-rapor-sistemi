<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Order GA Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
  <!-- Professional icon set -->
  <link rel="stylesheet" href="https://unpkg.com/@tabler/icons-webfont@latest/dist/tabler-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1d29;
      color: #ffffff;
      overflow-x: hidden;
    }
    .hamburger-btn {
      position: fixed;
      top: 16px;
      left: 16px;
      width: 44px;
      height: 44px;
      display: none;
      align-items: center;
      justify-content: center;
      background: #6366f1;
      color: #ffffff;
      border: 1px solid #4f46e5;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(99,102,241,0.35);
      cursor: pointer;
      z-index: 1100;
      transition: transform .2s ease, background .2s ease, left .3s ease;
      pointer-events: auto;
    }
    .hamburger-btn:active {
      transform: scale(0.96);
    }
    .hamburger-btn svg {
      color: #ffffff;
    }
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 80px;
      height: 100vh;
      background: #252836;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 0;
      z-index: 1000;
      transition: transform 0.3s ease;
    }
    .sidebar-item {
      width: 40px;
      height: 40px;
      margin: 15px 0;
      background: #3a3d4a;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      color: #ffffff;
    }
    .sidebar-item:hover { background: #4a4d5a; }
    .sidebar-item.active { background: #6366f1; box-shadow: 0 8px 24px rgba(99,102,241,0.35); }
    .sidebar-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(2px);
      opacity: 0;
      pointer-events: none;
      transition: opacity .3s ease;
      z-index: 900;
    }
    .main-content {
      margin-left: 80px;
      padding: 30px;
      min-height: 100vh;
    }
    
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        padding-top: 96px;
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .hamburger-btn {
        display: flex;
        left: 16px;
      }
      body.menu-open .hamburger-btn {
        left: 16px; /* Men√º a√ßƒ±kken buton men√º √ºzerinde kalsƒ±n */
      }
      .main-content {
        margin-left: 0;
        padding: 20px;
      }
      .header {
        padding-left: calc(44px + 24px);
      }
      .header h1 {
        line-height: 1.1;
      }
      .sidebar.open ~ .sidebar-overlay {
        opacity: 1;
        pointer-events: auto;
      }
      body.menu-open {
        overflow: hidden;
      }
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
    }
    .header h1 {
      font-size: 32px;
      font-weight: 600;
      color: #ffffff;
    }
    .header-right { display: flex; align-items: center; gap: 12px; flex-wrap: nowrap; }
    .logo-topright {
      height: 28px;
      width: auto;
      object-fit: contain;
      border-radius: 6px;
      background: #2a2e3f;
      padding: 4px 6px;
      border: 1px solid #374151;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }
    .date-range {
      background: #252836;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      color: #9ca3af;
    }
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }
    .metric-card {
      background: #252836;
      padding: 24px;
      border-radius: 12px;
      border: 1px solid #374151;
    }
    .metric-label {
      font-size: 14px;
      color: #9ca3af;
      margin-bottom: 8px;
    }
    .metric-value {
      font-size: 28px;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 4px;
    }
    .metric-change {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .metric-change.positive { color: #10b981; }
    .metric-change.negative { color: #ef4444; }
    .chart-section {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
      margin-bottom: 40px;
    }
    .chart-card {
      background: #252836;
      padding: 24px;
      border-radius: 12px;
      border: 1px solid #374151;
    }
    .chart-title {
      font-size: 18px;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 20px;
    }
    .upload-section {
      background: #1e1e2e;
      border: 1px solid #313244;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
    }
    .upload-section h2 {
      color: #cdd6f4;
      margin-bottom: 15px;
      font-size: 18px;
      font-weight: 600;
    }
    .load-btn {
      background: #89b4fa;
      color: #1e1e2e;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }
    .load-btn:hover {
      background: #74c0fc;
    }
    #dataStatus {
      margin-top: 10px;
      font-size: 14px;
      color: #a6adc8;
    }
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }
    .metric-card {
      background: #1e1e2e;
      border: 1px solid #313244;
      border-radius: 8px;
      padding: 20px;
    }
    .metric-label {
      color: #a6adc8;
      font-size: 14px;
      margin-bottom: 8px;
    }
    .metric-value {
      color: #cdd6f4;
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .metric-change {
      color: #a6e3a1;
      font-size: 12px;
    }
    .chart-section {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    .chart-card {
      background: #1e1e2e;
      border: 1px solid #313244;
      border-radius: 8px;
      padding: 20px;
    }
    .chart-title {
      color: #cdd6f4;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
    }
    .bottom-section {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
    }
    #daily-line, #source-pie {
      height: 400px;
      background: #181825;
      border-radius: 8px;
      margin: 10px 0;
    }
    .table-card {
      background: #1e1e2e;
      border: 1px solid #313244;
      border-radius: 8px;
      padding: 20px;
      margin-top: 24px;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    .data-table th, .data-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #2b2e3b;
      color: #cdd6f4;
    }
    .data-table th {
      text-align: left;
      color: #a6adc8;
      font-weight: 600;
      background: #252836;
    }
    .data-table tr:hover td {
      background: #222436;
    }
    .currency-usd { color: #a6e3a1; }
    .currency-eur { color: #89b4fa; }
    .currency-tl { color: #fab387; }
    /* Icon spacing */
    .chart-title i, .load-btn i, .upload-section h2 i { margin-right: 8px; vertical-align: -2px; }
    /* Mobil uyumluluk: k√º√ß√ºk ekranlarda grafikleri ve gridleri daha okunur yap */
    @media (max-width: 768px) {
      .chart-section { grid-template-columns: 1fr; gap: 16px; }
      .bottom-section { grid-template-columns: 1fr; }
      .metrics-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
      .chart-card { padding: 16px; }
      .chart-title { font-size: 14px; margin-bottom: 12px; }
      #daily-line, #source-pie { height: 300px; }
    }
  </style>
<style>
  /* Responsive enhancements */
  .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .data-table { min-width: 720px; }

  @media (max-width: 1200px) {
    .chart-section { grid-template-columns: 1fr; }
  }
  @media (max-width: 1024px) {
    .metrics-grid { grid-template-columns: repeat(2, 1fr); }
    .bottom-section { grid-template-columns: 1fr; }
    #daily-line, #source-pie, #bar-cari { height: 320px; }
    .chart-card, .metric-card { padding: 18px; }
  }
  @media (max-width: 768px) {
    .header h1 { font-size: 24px; }
    .date-range { font-size: 13px; }
    .main-content { padding: 20px; }
    .header { flex-direction: column; align-items: flex-start; gap: 12px; }
    .header-right { width: 100%; justify-content: space-between; }
    .date-range { white-space: nowrap; padding: 8px 12px; }
    .logo-topright { height: 24px; padding: 3px 5px; }
    .metrics-grid { grid-template-columns: 1fr; gap: 16px; }
    .chart-card { padding: 16px; }
    .chart-title { font-size: 16px; margin-bottom: 12px; }
    #daily-line, #source-pie, #bar-cari { height: 280px; }
  }
  @media (max-width: 480px) {
    .header h1 { font-size: 20px; }
    .hamburger-btn { width: 44px; height: 44px; }
    .metric-value { font-size: 24px; }
  }
</style>
</head>
<body>
  <button class="hamburger-btn" id="hamburgerBtn" aria-controls="siteSidebar" aria-expanded="false" aria-label="Men√ºy√º a√ß/kapat">
    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
      <rect x="3" y="6" width="18" height="2" rx="1" fill="currentColor"/>
      <rect x="3" y="11" width="18" height="2" rx="1" fill="currentColor"/>
      <rect x="3" y="16" width="18" height="2" rx="1" fill="currentColor"/>
    </svg>
  </button>
  <div class="sidebar" id="siteSidebar" aria-label="Ana men√º">
    <!-- Men√º ba≈ülƒ±ƒüƒ± / logo alanƒ± -->
    <div class="sidebar-item" aria-hidden="true" style="background: linear-gradient(135deg, #ffffff, #f8f9fa); box-shadow: 0 8px 24px rgba(0,0,0,0.15); border: 2px solid #e9ecef; padding: 6px;">
      <img src="LOGO.png" alt="CVS Air Logo" style="width: 28px; height: 28px; object-fit: contain;">
    </div>

    <a href="deneme.html" class="sidebar-item active" aria-label="Paneller">
      <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
      </svg>
    </a>
    <a href="detayli-rapor.html" class="sidebar-item" aria-label="Detaylƒ± Rapor">
      <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
      </svg>
    </a>
  </div>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <div class="main-content">
    <div class="header">
      <h1>Detaylƒ± Rapor</h1>
      <div class="header-right">
        <div class="date-range" id="dateRange" aria-live="polite"></div>
        <img src="LOGO.png" alt="CVS Air Logo" class="logo-topright" />
      </div>
    </div>

   

    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-label">Toplam Sipari≈ü</div>
        <div class="metric-value" id="sessions">-</div>
        <div class="metric-change" id="dsess">-</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Toplam Cari</div>
        <div class="metric-value" id="users">-</div>
        <div class="metric-change" id="duser">-</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Sayfa Miktar</div>
        <div class="metric-value" id="pviews">-</div>
        <div class="metric-change" id="dpv">-</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Gelir (USD)</div>
        <div class="metric-value" id="rev">-</div>
        <div class="metric-change" id="drev">-</div>
      </div>
    </div>

    <div class="chart-section">
       <div class="chart-card">
         <div class="chart-title"><i class="ti ti-chart-bar"></i> Projeler (Zamana G√∂re)</div>
         <div id="daily-line"></div>
       </div>
       <div class="chart-card">
        <div class="chart-title"><i class="ti ti-coins"></i> D√∂viz Cinsi Bazƒ±nda Toplam(Miktar)</div>
         <div id="source-pie"></div>
       </div>
     </div>
 
     <div class="bottom-section">
        <div class="upload-section">
        <h2><i class="ti ti-chart-line"></i> Sipari≈ü Verileri</h2>
        <button class="load-btn" onclick="loadCSVData()"><i class="ti ti-reload"></i> Verileri Yenile</button>
        <div id="dataStatus"><i class="ti ti-cloud-download"></i> Veriler y√ºkleniyor...</div>
    </div>
     </div>
     
  </div>
  <script>
    // Ensure Plotly is loaded and avoid 'Plotly is not defined' errors with CDN fallbacks
    (function ensurePlotly(){
      if (typeof window !== 'undefined' && typeof window.Plotly === 'undefined') {
        const sources = [
          'https://cdn.plot.ly/plotly-2.26.0.min.js',
          'https://cdn.jsdelivr.net/npm/plotly.js-dist-min@2.26.0/plotly.min.js',
          'https://unpkg.com/plotly.js-dist-min@2.26.0/plotly.min.js'
        ];
        let i = 0;
        const tryNext = () => {
          if (i >= sources.length) return;
          const s = document.createElement('script');
          s.src = sources[i++];
          s.async = true;
          s.onload = () => console.log('Plotly loaded:', s.src);
          s.onerror = () => { console.warn('Plotly load failed:', s.src); tryNext(); };
          document.head.appendChild(s);
        };
        tryNext();
        // Safety: define a no-op stub after 3s to prevent ReferenceError in rare cases
        setTimeout(() => {
          if (typeof window.Plotly === 'undefined') {
            window.Plotly = { newPlot: () => console.warn('Plotly not available; chart rendering skipped.') };
          }
        }, 3000);
      }
    })();
    
    // Fast timeout + retry + localStorage cache helpers
    async function fetchWithTimeout(url, options = {}, timeoutMs = 7000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeoutMs);
      try {
        const res = await fetch(url, { ...options, signal: controller.signal, cache: 'no-store' });
        return res;
      } finally { clearTimeout(id); }
    }
    async function retryFetch(url, options = {}, retries = 1, timeoutMs = 7000) {
      let attempt = 0, lastErr;
      while (attempt <= retries) {
        try { return await fetchWithTimeout(url, options, timeoutMs); }
        catch (err) { lastErr = err; attempt++; await new Promise(r => setTimeout(r, 400 * attempt)); }
      }
      throw lastErr;
    }
    const ORDERS_CACHE_KEY = 'ordersCache_v1';
    function readOrdersCache() {
      try {
        const raw = localStorage.getItem(ORDERS_CACHE_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!parsed || !Array.isArray(parsed.data)) return null;
        return parsed.data;
      } catch { return null; }
    }
    function writeOrdersCache(dataArray) {
      try {
        localStorage.setItem(ORDERS_CACHE_KEY, JSON.stringify({ ts: Date.now(), data: dataArray }));
      } catch {}
    }

    // IndexedDB helpers for persistent caching
    const IDB_NAME = 'cvsair-db';
    const IDB_VERSION = 2; // g√ºnl√ºk snapshotlar i√ßin v2
    const IDB_STORE_ORDERS = 'orders';
    const IDB_STORE_DAYS = 'days';

    function idbOpen() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(IDB_NAME, IDB_VERSION);
        req.onupgradeneeded = () => {
          const db = req.result;
          if (!db.objectStoreNames.contains(IDB_STORE_ORDERS)) {
            db.createObjectStore(IDB_STORE_ORDERS, { keyPath: 'key' });
          }
          if (!db.objectStoreNames.contains(IDB_STORE_DAYS)) {
            db.createObjectStore(IDB_STORE_DAYS, { keyPath: 'key' });
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function idbGetLatest() {
      try {
        const db = await idbOpen();
        return await new Promise((resolve, reject) => {
          const tx = db.transaction(IDB_STORE_ORDERS, 'readonly');
          const store = tx.objectStore(IDB_STORE_ORDERS);
          const req = store.get('latest');
          req.onsuccess = () => resolve(req.result || null);
          req.onerror = () => reject(req.error);
        });
      } catch (e) {
        console.warn('IndexedDB read error', e);
        return null;
      }
    }

    async function idbPutLatest(data) {
      try {
        const db = await idbOpen();
        return await new Promise((resolve, reject) => {
          const tx = db.transaction(IDB_STORE_ORDERS, 'readwrite');
          const store = tx.objectStore(IDB_STORE_ORDERS);
          const payload = { key: 'latest', data, updatedAt: Date.now() };
          const req = store.put(payload);
          req.onsuccess = () => resolve(true);
          req.onerror = () => reject(req.error);
        });
      } catch (e) {
        console.warn('IndexedDB write error', e);
        return false;
      }
    }

    async function idbGetDay(dayKey) {
      try {
        const db = await idbOpen();
        return await new Promise((resolve, reject) => {
          const tx = db.transaction(IDB_STORE_DAYS, 'readonly');
          const store = tx.objectStore(IDB_STORE_DAYS);
          const req = store.get(dayKey);
          req.onsuccess = () => resolve(req.result || null);
          req.onerror = () => reject(req.error);
        });
      } catch (e) {
        console.warn('IndexedDB read error (days)', e);
        return null;
      }
    }

    async function idbPutDay(dayKey, snapshot) {
      try {
        const db = await idbOpen();
        return await new Promise((resolve, reject) => {
          const tx = db.transaction(IDB_STORE_DAYS, 'readwrite');
          const store = tx.objectStore(IDB_STORE_DAYS);
          const payload = { key: dayKey, ...snapshot, updatedAt: Date.now() };
          const req = store.put(payload);
          req.onsuccess = () => resolve(true);
          req.onerror = () => reject(req.error);
        });
      } catch (e) {
        console.warn('IndexedDB write error (days)', e);
        return false;
      }
    }

    async function ensurePersistence() {
      if (navigator.storage && navigator.storage.persist) {
        try {
          const persisted = await navigator.storage.persisted();
          if (!persisted) {
            await navigator.storage.persist().catch(() => {});
          }
        } catch {}
      }
    }
    
    let prevData = null; // basit "√∂nceki d√∂nem" kar≈üƒ±la≈ütƒ±rmasƒ± i√ßin

    


    async function loadCSVData() {
      const statusDiv = document.getElementById('dataStatus');
      const currentTime = new Date().toLocaleTimeString('tr-TR');
      statusDiv.innerHTML = 'üì• Veriler API\'den y√ºkleniyor...';

      // Try IndexedDB first (persistent cache)
      try {
        const latest = await idbGetLatest();
        if (latest && Array.isArray(latest.data) && latest.data.length) {
          const when = new Date(latest.updatedAt).toLocaleString('tr-TR');
          statusDiv.innerHTML = `‚ö°Ô∏è IndexedDB'den ${latest.data.length} sipari≈ü y√ºklendi (√ñnceki kayƒ±t: ${when})`;
          processData(latest.data);
        }
      } catch {}
      
      // Show cached data immediately, if available
      const cached = readOrdersCache();
      if (cached && cached.length) {
        statusDiv.innerHTML = `‚úÖ ${cached.length} sipari≈ü y√ºklendi (Son g√ºncelleme: ${currentTime})`;
        processData(cached);
      }
      
      try {
        // Try to fetch from API first (fast timeout + one retry)
        const response = await retryFetch('/api/orders', {}, 1, 7000);
        
        if (!response.ok) {
          throw new Error(`API hatasƒ±: ${response.status}`);
        }
        
        const apiResponse = await response.json();
        
        if (!apiResponse.success) {
          throw new Error(apiResponse.error || 'API\'den veri alƒ±namadƒ±');
        }
        
        const jsonData = apiResponse.data;
        // Persist raw data to cache
        writeOrdersCache(jsonData);
        await idbPutLatest(jsonData);
        
        statusDiv.innerHTML = `‚úÖ ${jsonData.length} sipari≈ü API'den y√ºklendi (Son g√ºncelleme: ${currentTime})`;
        processData(jsonData);
        
      } catch (error) {
        console.error('API y√ºkleme hatasƒ±:', error);
        if (cached && cached.length) {
          statusDiv.innerHTML = `‚ö†Ô∏è API Hatasƒ±: ${error.message} - √ñnbellek verileri g√∂steriliyor`;
          processData(cached);
          return;
        }
        statusDiv.innerHTML = `‚ùå API Hatasƒ±: ${error.message} - √ñrnek veriler g√∂steriliyor`;
        
        // Fallback to sample data if API fails
        showSampleData();
      }
    }
    
    function showSampleData() {
      const statusDiv = document.getElementById('dataStatus');
      statusDiv.innerHTML = '‚ö†Ô∏è API eri≈üimi ba≈üarƒ±sƒ±z - √ñrnek veriler g√∂steriliyor';
      
      // Yeni ≈üemaya uygun √∂rnek veriler
      const sampleData = [
        {
          "tarih": "2025-08-29T00:00:00",
          "cari": "DFN PROJE M√úHENDƒ∞SLƒ∞K DANI≈ûMANLIK Tƒ∞CARET Lƒ∞Mƒ∞TED ≈ûƒ∞RKETƒ∞",
          "srmkod": "",
          "srmad": "TANIMSIZ",
          "miktar": 42,
          "teslim": 0,
          "tutar": 11665.2,
          "nettutar": 11665.2,
          "doviz": "USD",
          "kalanmik": 42,
          "kalannet": 11665.2,
          "proje": "DFN KAHRAMANMARA≈û DEPREM KONUTLARI1.PART",
          "durum": "A√ßƒ±k"
        },
        {
          "tarih": "2025-08-30T00:00:00",
          "cari": "DFN MALATYA 1262",
          "srmkod": "",
          "srmad": "DFN MALATYA",
          "miktar": 10000,
          "teslim": 0,
          "tutar": 10000,
          "nettutar": 10000,
          "doviz": "TL",
          "kalanmik": 10000,
          "kalannet": 10000,
          "proje": "DFN MALATYA 1262",
          "durum": "A√ßƒ±k"
        },
        {
          "tarih": "2025-08-31T00:00:00",
          "cari": "ALBAYENT YILDIZ ENTE",
          "srmkod": "",
          "srmad": "ALBAYENT",
          "miktar": 8200,
          "teslim": 0,
          "tutar": 8200,
          "nettutar": 8200,
          "doviz": "EUR",
          "kalanmik": 8200,
          "kalannet": 8200,
          "proje": "ALBAYENT YILDIZ ENTE",
          "durum": "A√ßƒ±k"
        }
      ];
      
      processData(sampleData);
    }
    
    function parseCSV(csvText) {
      const lines = csvText.trim().split('\n');
      const headers = lines[0].split(',');
      const data = [];
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        
        // Skip empty lines and summary lines
        if (!line || line.startsWith(',') || !line.includes(',')) {
          continue;
        }
        
        // Handle quoted values properly - split by comma but respect quotes
        const values = [];
        let current = '';
        let inQuotes = false;
        
        for (let j = 0; j < line.length; j++) {
          const char = line[j];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            values.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        values.push(current.trim()); // Add the last value
        
        // Skip lines that don't have proper data structure
        if (values.length < headers.length) {
          continue;
        }
        
        const row = {};
        
        headers.forEach((header, index) => {
          let value = values[index] ? values[index].trim().replace(/"/g, '') : '';
          
          // Convert numeric fields with comma separators
          if (header.includes('TUTAR') || header.includes('Mƒ∞KTAR')) {
            // Remove quotes and convert comma-separated numbers
            value = value.replace(/"/g, '').replace(/,/g, '').replace(/\s+/g, '');
            row[header.trim()] = parseFloat(value) || 0;
          } else {
            row[header.trim()] = value;
          }
        });
        
        // Only add rows with valid date and customer name, or summary rows with currency data
        if ((row['Sƒ∞PARƒ∞≈û TARƒ∞Hƒ∞'] && row['CARƒ∞ ƒ∞SMƒ∞']) || 
            (row['DOVƒ∞Z Cƒ∞NSƒ∞'] && row['KALAN Sƒ∞PARƒ∞≈û NET TUTAR'] && !row['Sƒ∞PARƒ∞≈û TARƒ∞Hƒ∞'])) {
          // For summary rows, add a fake date to make them processable
          if (!row['Sƒ∞PARƒ∞≈û TARƒ∞Hƒ∞'] && row['DOVƒ∞Z Cƒ∞NSƒ∞']) {
            row['Sƒ∞PARƒ∞≈û TARƒ∞Hƒ∞'] = '01.01.2025';
            row['CARƒ∞ ƒ∞SMƒ∞'] = '√ñzet';
          }
          data.push(row);
        }
      }
      
      return data;
    }



    function processData(raw){
      // Yardƒ±mcƒ±lar
      const num = (x)=>{
        if (x === null || x === undefined) return 0;
        if (typeof x === 'number') return x;
        let s = String(x).replace(/\s+/g,'');
        if (s.includes('.') && s.includes(',')) {
          s = s.replace(/\./g,'').replace(',', '.');
        } else {
          s = s.replace(',', '.');
        }
        const v = parseFloat(s);
        return isNaN(v) ? 0 : v;
      };
      const parseDate = (s)=>{
        if (!s) return new Date();
        const d = new Date(s);
        if (!isNaN(d)) return d;
        // DD.MM.YYYY
        const m = String(s).split('.');
        if (m.length === 3) {
          const day = parseInt(m[0]), month = parseInt(m[1]) - 1, year = parseInt(m[2]);
          const dd = new Date(year, month, day);
          if (!isNaN(dd)) return dd;
        }
        // Excel serial
        const ex = parseFloat(s);
        if (!isNaN(ex) && ex > 25569) return new Date((ex - 25569) * 86400 * 1000);
        return new Date();
      };
      const normalize = (arr)=> arr.map(r=>{
        const clean = (s)=>String(s||'').trim();
        const isUnknown = (s)=>{ const t = clean(s).toLowerCase(); return !t || t === 'tanƒ±msƒ±z' || t.startsWith('bilinmeyen'); };
        // Proje adƒ± i√ßin zengin aday listesi (API: proje_ad / proje_adi dahil)
        const projectCandidates = [
          r.proje, r['PROJE'], r['Proje'], r['project'], r['proje_ad'], r['proje_adi'],
          r['Sorumluluk Merkezi Adƒ±'], r.srmad, r.cari
        ];
        let resolvedProject = '';
        for (const c of projectCandidates) { if (!isUnknown(c)) { resolvedProject = clean(c); break; } }
        return {
          tarih: r.tarih ? r.tarih : (r['Sƒ∞PARƒ∞≈û TARƒ∞Hƒ∞'] || ''),
          cari: clean(r.cari || r['CARƒ∞ ƒ∞SMƒ∞'] || ''),
          srmkod: clean(r.srmkod || r['Sorumluluk Merkezi Kodu'] || ''),
          // SRM adƒ±: proje fallback kaldƒ±rƒ±ldƒ±, ger√ßek SRM alanlarƒ±na √∂ncelik verildi
          srmad: clean(r.srmad || r['Sorumluluk Merkezi Adƒ±'] || r['Sorumluluk Merkezi'] || ''),
          miktar: num(r.miktar ?? r['Mƒ∞KTAR']),
          teslim: num(r.teslim ?? r['TESLƒ∞M Mƒ∞KTAR']),
          tutar: num(r.tutar ?? r['Sƒ∞PARƒ∞≈û SATIR TOPLAM TUTAR'] ?? r['TOPLAM TUTAR']),
          nettutar: num(r.nettutar ?? r['Sƒ∞PARƒ∞≈û SATIR NET TUTAR'] ?? r['NET TUTAR']),
          doviz: clean(r.doviz || r['DOVƒ∞Z Cƒ∞NSƒ∞'] || 'TL').toUpperCase(),
          kalanmik: num(r.kalanmik ?? r['KALAN Sƒ∞PARƒ∞≈û Mƒ∞KTARI'] ?? r['Mƒ∞KTAR']),
          kalannet: num(r.kalannet ?? r['KALAN Sƒ∞PARƒ∞≈û NET TUTAR'] ?? r['NET TUTAR']),
          // Proje adƒ±: TANIMSIZ ise SRM/cari fallback; en azƒ±ndan anlamlƒ± bir etiket √ºret
          proje: resolvedProject,
          durum: clean(r.durum || ((num(r.kalanmik) > 0 || num(r.kalannet) > 0) ? 'A√ßƒ±k' : 'Kapalƒ±'))
        };
      });

      const now = normalize(raw);
      if(!prevData) { prevData = JSON.parse(JSON.stringify(now)); }
      const prev = prevData;

      // KPI (USD geliri etiketi ile uyum i√ßin USD toplamƒ±)
      const kpi = (d)=>({
        sessions: d.length,
        users: new Set(d.map(r=>r.cari)).size,
        pviews: d.reduce((s,r)=>s+(r.miktar||0),0),
        rev: d.reduce((s,r)=>s+((r.doviz==='USD' ? (r.kalannet||0) : 0)),0)
      });
      // Kalƒ±cƒ± baz deƒüer ile delta hesaplama (toplamaya g√∂re ekle/√ßƒ±kar ve baz deƒüeri g√ºncelle)
      const KPI_PREV_KEY = 'kpi_prev_v1';
      const readPrevKpi = () => {
        try { const raw = localStorage.getItem(KPI_PREV_KEY); return raw ? JSON.parse(raw) : null; } catch { return null; }
      };
      const writePrevKpi = (obj) => {
        try { localStorage.setItem(KPI_PREV_KEY, JSON.stringify({ ...obj, ts: Date.now() })); } catch {}
      };

      const kNow = kpi(now);
      const prevKpi = readPrevKpi() || kNow;
      const fmtAbs = (n)=> (n>=0?'+':'') + (Math.round(n)).toLocaleString('tr-TR');
      const dSessAbs = kNow.sessions - prevKpi.sessions;
      const dUserAbs = kNow.users - prevKpi.users;
      const dPviewsAbs = kNow.pviews - prevKpi.pviews;
      const dRevAbs = kNow.rev - prevKpi.rev;
      const dSessPct = prevKpi.sessions ? (dSessAbs/prevKpi.sessions*100) : 0;
      const dUserPct = prevKpi.users ? (dUserAbs/prevKpi.users*100) : 0;
      const dPviewsPct = prevKpi.pviews ? (dPviewsAbs/prevKpi.pviews*100) : 0;
      const dRevPct = prevKpi.rev ? (dRevAbs/prevKpi.rev*100) : 0;

      document.getElementById('sessions').textContent = kNow.sessions.toLocaleString('tr-TR');
      document.getElementById('dsess').textContent = `${fmtAbs(dSessAbs)} (${dSessPct.toFixed(1)}%) √∂nceki deƒüere g√∂re`;
      document.getElementById('users').textContent = kNow.users.toLocaleString('tr-TR');
      document.getElementById('duser').textContent = `${fmtAbs(dUserAbs)} (${dUserPct.toFixed(1)}%) √∂nceki deƒüere g√∂re`;
      document.getElementById('pviews').textContent = kNow.pviews.toLocaleString('tr-TR');
      document.getElementById('dpv').textContent = `${fmtAbs(dPviewsAbs)} (${dPviewsPct.toFixed(1)}%) √∂nceki deƒüere g√∂re`;
      document.getElementById('rev').textContent = '$'+kNow.rev.toLocaleString('tr-TR', {minimumFractionDigits: 2});
      document.getElementById('drev').textContent = `${dRevAbs>=0?'+':''}$${Math.abs(dRevAbs).toLocaleString('tr-TR', {minimumFractionDigits: 2})} (${dRevPct.toFixed(1)}%) √∂nceki deƒüere g√∂re`;

      // Bazƒ± yeni deƒüerle g√ºncelle (veriler silinmeden k√ºm√ºlatif mantƒ±k)
      writePrevKpi(kNow);

      // Date parse
      now.forEach(r=>{ r.date = parseDate(r.tarih); });

      // G√ºnl√ºk toplamlar (nettutar, d√∂viz bazƒ±nda) ve snapshot yazƒ±mƒ±
      (async ()=>{
        try {
          const dayTotals = new Map();
          let maxDate = null;
          now.forEach(r => {
            const d = r.date instanceof Date ? r.date : new Date(r.date);
            if (isNaN(d)) return;
            const dayKey = d.toISOString().slice(0,10);
            const cur = (r.doviz || 'TL').toUpperCase();
            const val = Number(r.nettutar) || 0;
            if (!dayTotals.has(dayKey)) dayTotals.set(dayKey, { count:0, byCurrency:{TL:0, USD:0, EUR:0} });
            const dt = dayTotals.get(dayKey); dt.count += 1; dt.byCurrency[cur] = (dt.byCurrency[cur]||0) + val;
            if (!maxDate || d > maxDate) maxDate = d;
          });
          if (!maxDate) return;
          const latestKey = maxDate.toISOString().slice(0,10);
          const prevDate = new Date(maxDate); prevDate.setDate(prevDate.getDate()-1);
          const prevKey = prevDate.toISOString().slice(0,10);
          const latestTotals = dayTotals.get(latestKey);
          if (latestTotals) { await idbPutDay(latestKey, { count: latestTotals.count, byCurrency: latestTotals.byCurrency }); }
          const prevTotals = dayTotals.get(prevKey);
          if (prevTotals) {
            const existingPrev = await idbGetDay(prevKey);
            if (!existingPrev) { await idbPutDay(prevKey, { count: prevTotals.count, byCurrency: prevTotals.byCurrency }); }
          }
        } catch (e) { console.warn('G√ºnl√ºk snapshot yazma hatasƒ±', e); }
      })();

      // Aylara g√∂re toplam kolon grafiƒüi (firma/proje ayrƒ±mƒ± olmadan)
      const monthTotals = {};
      const fmtMonth = (key) => { const [y,m] = key.split('-'); return `${m}.${y}`; };
      now.forEach(r => {
        const y = r.date?.getFullYear?.() || new Date(r.date).getFullYear();
        const m = (r.date?.getMonth?.() ?? new Date(r.date).getMonth()) + 1;
        const key = `${y}-${String(m).padStart(2,'0')}`;
        const curr = (r.doviz || 'TL').toUpperCase();
        if (!monthTotals[key]) monthTotals[key] = { TL: 0, USD: 0, EUR: 0 };
        const val = Number(r.kalannet || 0) || 0;
        if (curr in monthTotals[key]) monthTotals[key][curr] += val; else {
          // Diƒüer d√∂vizler i√ßin ayrƒ± anahtar gerekirse eklenebilir; ≈üimdilik yok sayƒ±lƒ±yor
        }
      });
      const months = Object.keys(monthTotals).sort();
      const tlVals = months.map(k => monthTotals[k].TL || 0);
      const usdVals = months.map(k => monthTotals[k].USD || 0);
      const eurVals = months.map(k => monthTotals[k].EUR || 0);
      const xLabels = months.map(fmtMonth);

      const monthlyTraces = [
        { x: xLabels, y: tlVals, type: 'bar', name: 'TL', marker: { color: '#fab387' } },
        { x: xLabels, y: usdVals, type: 'bar', name: 'USD', marker: { color: '#a6e3a1' } },
        { x: xLabels, y: eurVals, type: 'bar', name: 'EUR', marker: { color: '#89b4fa' } }
      ];
      
      // Ensure Plotly is available before rendering charts
      const renderCharts = () => {
        if (typeof window.ApexCharts === 'undefined') {
          console.warn('ApexCharts not loaded yet, retrying in 500ms...');
          setTimeout(renderCharts, 500);
          return;
        }
        
        try {
          const isMobile = window.matchMedia('(max-width: 768px)').matches;
          const dailyLayout = {
          title: {
            text: '',
            font: {color: '#cdd6f4', size: 16, family: 'Inter, sans-serif'}
          },
          xaxis: {
            title: { text: 'Ay', font: {color: '#cdd6f4', size: 14, family: 'Inter, sans-serif'} },
            color: '#cdd6f4',
            gridcolor: '#45475a',
            gridwidth: 1,
            showgrid: true,
            type: 'category',
          tickfont: {color: '#a6adc8', size: isMobile ? 10 : 11},
            linecolor: '#6c7086',
            linewidth: 2,
            mirror: true
          },
          yaxis: {
            title: { text: 'Aylƒ±k Toplam', font: {color: '#cdd6f4', size: 14, family: 'Inter, sans-serif'} },
            color: '#cdd6f4',
            gridcolor: '#45475a',
            gridwidth: 1,
            showgrid: true,
            tickformat: ',.0f',
          tickfont: {color: '#a6adc8', size: isMobile ? 10 : 11},
            linecolor: '#6c7086',
            linewidth: 2,
            mirror: true,
            zeroline: true,
            zerolinecolor: '#6c7086',
            zerolinewidth: 2
          },
          showlegend: true,
          legend: {
          font: {color: '#cdd6f4', size: isMobile ? 11 : 12, family: 'Inter, sans-serif'},
          bgcolor: 'rgba(30, 30, 46, 0.8)',
          bordercolor: '#6c7086',
          borderwidth: 1,
          orientation: isMobile ? 'h' : 'v',
          x: isMobile ? 0.5 : 1.02,
          y: isMobile ? 1.05 : 1,
          xanchor: isMobile ? 'center' : 'left',
          yanchor: isMobile ? 'bottom' : 'top'
          },
          paper_bgcolor: '#181825',
          plot_bgcolor: '#1e1e2e',
          font: {color: '#cdd6f4', family: 'Inter, sans-serif'},
        height: isMobile ? 300 : 380,
        margin: {l: isMobile ? 50 : 80, r: isMobile ? 20 : 140, t: isMobile ? 40 : 50, b: isMobile ? 60 : 80},
          hovermode: 'x unified',
          barmode: isMobile ? 'stack' : 'group',
          bargap: isMobile ? 0.1 : 0.01,
          bargroupgap: isMobile ? 0.1 : 0.01,
          transition: {
            duration: 500,
            easing: 'cubic-in-out'
          }
      };
          // Render monthly totals with ApexCharts for smoother, shaded look
          if (window.dailyApex) { try { window.dailyApex.destroy(); } catch(e){} }
          const apexOptions = {
            chart: {
              type: 'bar',
              height: isMobile ? 300 : 380,
              background: '#1e1e2e',
              foreColor: '#cdd6f4',
              toolbar: { show: true },
              dropShadow: { enabled: true, top: 3, left: 0, blur: 6, opacity: 0.25 }
            },
            series: [
              { name: 'TL', data: tlVals },
              { name: 'USD', data: usdVals },
              { name: 'EUR', data: eurVals }
            ],
            colors: ['#fab387', '#a6e3a1', '#89b4fa'],
            xaxis: {
              categories: xLabels,
              axisBorder: { show: true, color: '#6c7086', height: 2 },
              axisTicks: { show: true, color: '#6c7086' },
              labels: { style: { colors: '#a6adc8', fontSize: isMobile ? '10px' : '11px' } },
              title: { text: 'Ay', style: { color: '#cdd6f4', fontSize: '14px' } }
            },
            yaxis: {
              title: { text: 'Aylƒ±k Toplam', style: { color: '#cdd6f4', fontSize: '14px' } },
              labels: { formatter: (val) => Math.round(val).toLocaleString('tr-TR'), style: { colors: '#a6adc8', fontSize: isMobile ? '10px' : '11px' } }
            },
            grid: { borderColor: '#45475a', strokeDashArray: 2 },
            legend: { show: true, position: isMobile ? 'top' : 'right', horizontalAlign: isMobile ? 'center' : 'left' },
            plotOptions: { bar: { horizontal: false, columnWidth: isMobile ? '60%' : '55%', borderRadius: 8, borderRadiusApplication: 'end' } },
            dataLabels: { enabled: false },
            fill: { type: 'gradient', gradient: { shade: 'dark', type: 'vertical', shadeIntensity: 0.35, gradientToColors: ['#f9e0c7', '#c7f7d6', '#c1d8ff'], inverseColors: false, opacityFrom: 0.95, opacityTo: 0.85, stops: [0, 100] } },
            tooltip: { theme: 'dark', y: { formatter: (val) => Number(val).toLocaleString('tr-TR') } }
          };
          window.dailyApex = new ApexCharts(document.querySelector('#daily-line'), apexOptions);
          window.dailyApex.render();

      // Currency-based revenue donut (ApexCharts for modern shaded look)
      const currencyRevenue = {};
      now.forEach(r=>{ 
        const currency = r.doviz || 'TL'; 
        currencyRevenue[currency] = (currencyRevenue[currency]||0) + (r.kalannet||0); 
      });

      const shortAmount = (n) => {
        const abs = Math.abs(n || 0);
        const sign = (n||0) < 0 ? '-' : '';
        if (abs >= 1_000_000_000) return `${sign}${Math.round(abs/1_000_000_000)}B`;
        if (abs >= 1_000_000) return `${sign}${Math.round(abs/1_000_000)}M`;
        if (abs >= 1_000) return `${sign}${Math.round(abs/1_000)}K`;
        return `${sign}${abs.toLocaleString('tr-TR', { maximumFractionDigits: 0 })}`;
      };

      const pieSeries = Object.values(currencyRevenue);
      const pieLabels = Object.keys(currencyRevenue);

      if (window.pieApex) { try { window.pieApex.destroy(); } catch(e){} }
      const pieOptions = {
        chart: {
          type: 'donut',
          height: isMobile ? 280 : 300,
          background: '#181825',
          foreColor: '#cdd6f4',
          toolbar: { show: true },
          dropShadow: { enabled: true, top: 2, left: 0, blur: 6, opacity: 0.25 }
        },
        series: pieSeries,
        labels: pieLabels,
        colors: ['#89b4fa', '#f38ba8', '#a6e3a1', '#fab387', '#cba6f7'],
        legend: {
          show: true,
          position: isMobile ? 'bottom' : 'right',
          horizontalAlign: isMobile ? 'center' : 'left',
          formatter: function(seriesName, opts) {
            const val = opts.w.globals.series[opts.seriesIndex];
            return seriesName + ': ' + shortAmount(val);
          }
        },
        stroke: { width: 2, colors: ['#181825'] },
        dataLabels: {
          enabled: true,
          style: { fontSize: isMobile ? '10px' : '12px' },
          formatter: function(value, opts) {
            const label = opts.w.globals.labels[opts.seriesIndex];
            const val = opts.w.config.series[opts.seriesIndex];
            return label + ': ' + shortAmount(val);
          }
        },
        fill: { type: 'gradient', gradient: { shade: 'dark', type: 'horizontal', shadeIntensity: 0.35, gradientToColors: undefined, inverseColors: false, opacityFrom: 0.98, opacityTo: 0.85, stops: [0, 100] } },
        plotOptions: {
          pie: {
            donut: {
              size: '60%',
              labels: {
                show: true,
                name: { show: true, fontSize: isMobile ? '11px' : '14px', color: '#cdd6f4' },
                value: { show: true, fontSize: isMobile ? '12px' : '16px', color: '#cdd6f4', formatter: (val) => shortAmount(val) },
                total: {
                  show: true,
                  showAlways: true,
                  label: 'Toplam',
                  fontSize: isMobile ? '11px' : '12px',
                  color: '#a6adc8',
                  formatter: (w) => shortAmount(w.globals.seriesTotals.reduce((a,b)=> a + b, 0))
                }
              }
            }
          }
        },
        tooltip: { theme: 'dark', y: { formatter: (val) => shortAmount(val) } }
      };
      window.pieApex = new ApexCharts(document.querySelector('#source-pie'), pieOptions);
      window.pieApex.render();

      // (M√º≈üteri miktar grafiƒüi kaldƒ±rƒ±ldƒ±)
      
      } catch (error) {
        console.error('Chart rendering error:', error);
      }
    };
    
    // Call renderCharts function
    renderCharts();
    }
      
      // Auto-load data when page loads
      document.addEventListener('DOMContentLoaded', function() {
        ensurePersistence();
        loadCSVData();
      });
      
      // Fallback for window load event
      window.addEventListener('load', function() {
        // Only load if data hasn't been loaded yet
        const statusDiv = document.getElementById('dataStatus');
        if (statusDiv && statusDiv.innerHTML === 'üì• Veriler y√ºkleniyor...') {
          loadCSVData();
        }
      });

      // Hamburger menu functionality is handled by the unified initMenuToggle() below
    </script>
<script>
(function initMenuToggle(){
    const btn = document.getElementById('hamburgerBtn');
    const sidebar = document.getElementById('siteSidebar');
    const overlay = document.getElementById('sidebarOverlay');
    if (!btn || !sidebar) return;

    const openMenu = ()=> {
      sidebar.classList.add('open');
      document.body.classList.add('menu-open');
      btn.setAttribute('aria-expanded','true');
    };
    const closeMenu = ()=> {
      sidebar.classList.remove('open');
      document.body.classList.remove('menu-open');
      btn.setAttribute('aria-expanded','false');
    };
    const toggle = (e)=>{ e?.preventDefault?.(); const isOpen = sidebar.classList.contains('open'); isOpen ? closeMenu() : openMenu(); };

    // Deduplicate touch/click: ignore synthetic click fired after touch
    function bindTap(el, handler) {
      if (!el) return;
      if ('onpointerup' in window) {
        el.addEventListener('pointerup', handler);
      } else {
        let lastTouch = 0;
        el.addEventListener('touchstart', (e)=>{ lastTouch = Date.now(); handler(e); }, { passive: true });
        el.addEventListener('click', (e)=>{ if (Date.now() - lastTouch < 500) return; handler(e); });
      }
    }

    bindTap(btn, toggle);
    bindTap(overlay, closeMenu);
    window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeMenu(); });
    // Close the menu when a sidebar item is clicked
    (sidebar.querySelectorAll?.('a.sidebar-item') || []).forEach(a=>{ a.addEventListener('click', closeMenu); });
  })();

  function resizeCharts() {
    // If ApexCharts instances exist, trigger a render to ensure responsiveness
    if (window.dailyApex && typeof window.dailyApex.render === 'function') {
      try { window.dailyApex.render(); } catch (e) {}
    }
    if (window.pieApex && typeof window.pieApex.render === 'function') {
      try { window.pieApex.render(); } catch (e) {}
    }
  }
  window.addEventListener('resize', resizeCharts);
  window.addEventListener('orientationchange', resizeCharts);
</script>
<script>
  // Live current time in header (Turkish locale, 24-hour)
  function startHeaderClock() {
    const el = document.getElementById('dateRange');
    if (!el) return;
    const fmt = () => new Date().toLocaleString('tr-TR', {
      year: 'numeric', month: 'short', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
    }).replace(',', '');
    el.textContent = `≈ûu an: ${fmt()}`;
    setInterval(() => { el.textContent = `≈ûu an: ${fmt()}`; }, 1000);
  }
  document.addEventListener('DOMContentLoaded', startHeaderClock);
</script>
</body>
</html>